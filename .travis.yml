cache:
  directories:
  - "$HOME/.cache/pre-commit"
stages:
- "system tests"
- linting
- test
- deploy
language: python
python:
- '3.5'
- '3.6'
- '3.7'
- '3.8'
- 'pypy3'
install:
- pip install -r requirements-test.txt
- pip install tox-travis
script: tox

env:
  global:
    # DAR_CLIENT_ID
    - secure: "eT6zcQaKWSPwycwHRB5o+aO9eSQBOU8ai22sqPOJz580OUA30wT9PJLUeL2R8w91oY6Nkxopm6kmX1hWcrgQUbzGzTfCbuRVu6LdX3tvKuWEcXYAWXbcFne9d15PnKEeHEj59S1+77xXJCLUsgv1AERlHpSFWh9Wy6ZjAsDQX5OxpnOuUQUkRdTWs93swVV280Zcph6oLWMQe42zFqvehagNqdXGYDxd+9cZFvxB4jFk3KBwBXKSlQIaV2oRKQNlKb3S00XNMLGVN3FUMJLwl8PNzlz19nhtllgpqjykd6YeReJXhPVy+NKQ7Syhd0BurShnj2aHZHbtBK+h3Hy3fnJQ+ZNYR4Z0Oj7VWMYlCzGYedfbj6qfKVCEI80eNHAa2jZ/nCOZRgU/0nZCuWwvrqdI6dIVz9j3ep4JS38J/E9V5OTmQNp2sZ6poLvqIENUln3K5g/HhHvjZuoF8/A8/gSOKOfGFb2tVcDFd05B3zd19cpqCx98EeNXBw6r97fKaxcWGTaiXerFlEzMV7XJKpPTuhaPKktssAZwEojSwEjDYIUXtSwkyVdAnNkGHu3EKY9Rk9LOpuMEFzAnH54qiM86IyyIIRhLrnfFm8bomAjD9ouztAbcGrCfJ1dBXzCi//0uu4owhiGwUU+kvbmVRmE6vJ2QK3driWz5BCnWSBM="
    # DAR_CLIENT_SECRET
    - secure: "hzkeS3fpDirD5hmSV21SD+F3CvrJnmwRBntBc+d2nfsx9LHUf/2rkedGmbaeGYQG+XyayM0McUg15y1CEw0nzZ6eaDtF87hUN6ClBiSzjXSFbcqYsD8jlAB2xtOkvGj4Odfj+jeW0A3N0P/GsBua2l6zffhNJNJ1x1kJwZbaRMdmJuDi2e+qpUZuOS0AdlbUmb/aOls8ZC0YcJfCrTahHaQNtQN5b39tcE/rR/aKPGzkhEUUFN7ujw7ktEH6bMz5FU6OfXPaM6xqx0kdl3DecH/PNE1KqTnEcb0d8dOHnF/QrXTN5QI54pBBDaUl77KAQLQRBMieCODGcly9yAFIJFq4tJGJjj8vhpdfJc68CH6SCTV/r7ktIi16p0tJurA4w4o5vdrpzuzMdDvWr5dMmXHcCfdZq9tLpKRY+UFcEekIkZYkXmdAQdSb8LAJKTdSEReZ0fzB4Cl8AXZtTNJK4kG8JYnDrau6LErxggYl2o5XJsl6ECRbG5KlQIG8EzNrkcRhD503zRQp5pAQltixd5DcEa9nMx4muGK3TsdxJdX2mbNw6etH4qjLi6OMYf+chvkVnPku78aEO/GrPwhZRzSKAWdoZ7mZKHgBXBjxFQ9MZCkR7RSh2tMpydaM1NSMDOrkoepM3ytueCgjqzaHTSBCf2jhYxzhBZ7DzX3d2KQ="
    # DAR_AUTH_URL
    - secure: "GNzN78NM9I7ky6eUPPLGD7tE+srhaZ4SfslahGy82Yxur3u54RsnkzrJW/s6anc69+OnttKRdgQcFLl3GGOUeeRrnQ48ROgqdf7KIuUSpc0Jzf6fkqOHflwhtMDdVEoxrg+AKTZ2MxsGWVVeL7sWTl0qhQSlNiRHGEzspI49TQ7Gf+wXJKoc9ivJRdEW57zWVzWB0JnJidjrLQ7Ll8A1J1HlWgQlocOKWcpWbmDSPZnHDb7M3xGuY+odVLBSqh45Zki43l/sutufFTg8AcQXvFjN7TJoZBsaavvwanUDcAYpWInmJp+MDAgfqp0P+1VVij34q+rBQa61B6HCBPDa3chzfjPfTUlrUhsAQGCqkpW3SwjLZqtvLSp5wgqiBbiUfQGNG3YPXcjC+5pFdJ6vvdx/QxBtN/CLdiabhdxWiWElHi196RgPdC/+4yhHCq+j26lFks3U1ELU5P48+jEVgoZ7WeaqQvhgOBiMOZ3zoLlHUd15lX9qF2saCI16yoxx5wB7o+FOgy/2klJ/zyy7XZY3nzg0V0pWLe+ZmfAsCqmz1O8ne80tUmcVCRGiChAltE1AxMWjvTr1Vm4D9nIXcdJ6iMEf4LRXbKqr02lmuNI3NsBRK2Za8p7ZTiFZ86AfILt0xxDZpqeD7wYZ8UG6d3IAR8P2UJfPcAwOwqWVAkQ="


jobs:
  include:
  - stage: linting
    python: '3.7' # only run once.
    install:
    - pip install -r requirements-dev.txt
    script:
    - pyenv global 3.7.1
    - pre-commit run --all-files
  - stage: system tests
    python: '3.7' # only run once.
    # use install: from global test stage, since system tests are
    # also handled via tox
    script:
      - tox -e system_tests
  - stage: deploy
    python: '3.7' # only run once
    install: skip
    script: skip
    deploy:
      provider: pypi
      username: __token__
      distributions: "sdist bdist_wheel"
      password:
        secure: K0ExrJP+kneqCO5DKhv6+rzUXaKOoj0ORtCS/WS5MPndgLqRB77k0zWZj7ju/xI/5XvCk+SyxFHBbTA+izKyllsk/BmWngVcCcpoEJPhpTMDkd1cXbGwWDhV+ZNsCCxofx23g/877shbpWhsvqY4lZxGUfF1oFu9j0hJw6FhXasE46J8T0x2T6gGJ5DDnnKyXY8LI3jL7pS+tA19QXtR1pNrPSFeyIbwHsCStx4FWpdjA+5NzD/CSQvYlj7nwFtf5GSSbepcccgqYsQDmd5l3S6b8Wn3Cn959K8UWXwjEWRUQ/mSpdx7x6pYAGKxdIaMhloTzpK+24vuQ+oOwOPdD88Ii1UkEv+YRFupPKDqDflDx0t3F75WpuV9+a3vdij1Ge+HI8u/kzmijk3grV992+9FikwaNjAm7yHwjy29Mit1FAzJQKD9CfdoievEweUi+ewFb0hXlA6jxcUtpaxqVpc1acJ1dcYekhiGSkBGZX9UvjALsneAUZuQUbxfpPoMTXoUPNj4ADEeOwU77ksTnZALl8QnrNOIUZMQyEczz87X+DLV7B05foz6CwIxElJodxHm3dqqDBMZbeYL36kezd2KLXPGaNq5WOE7z36KJeSVLhob0+8k00POavYlxeSjVe8KckBgk9Q+l2UdBtCkSfJoV8M2MXJUOOg+rG6bMCQ=
      on:
        tags: true # use `git tag -a "a-tag" -m "a message" && git push --tags` to release.
        branch: master
